
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Learn how to integrate the Eduponics mini kit with Eduponics app to create a remote controlled smart garden, IoT irrigation system or smart watering solution">
      
      
      
      
      <link rel="icon" href="https://cdn.steminds.com/docs/images/icon.svg">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>STEMinds - Eduponics APP - STEMinds Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../../stylesheets/style-starter.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-165700957-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="default" data-md-color-accent="amber">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eduponics-mqtt-powered-mobile-app" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Mitigate bug: https://github.com/mkdocs/mkdocs/issues/2191 -->



<!-- Application header -->
<header class="w3l-bootstrap-header" data-md-component="header">
    <nav class="navbar navbar-expand-lg navbar-dark py-lg-2 py-2">
      <div class="container">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <!-- Button to open drawer -->
          <label class="md-header-nav__button md-icon" for="__drawer">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
          </label>
        </button>

        <a class="navbar-brand" href="#index.html" style="color: #FFC51D;">
            <img src="https://cdn.steminds.com/docs/images/icon.svg" alt="STEMinds" title="STEMinds" style="height:48px;" />
            STEMinds
        </a>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item">
              <a class="nav-link" href="https://steminds.com/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://shop.steminds.com/">Products</a>
            </li>
              <li class="nav-item">
              <a class="nav-link" href="https://wiki.steminds.com/">Documentation</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://steminds.com/contact.html">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="STEMinds Documentation" class="md-nav__button md-logo" aria-label="STEMinds Documentation" data-md-component="logo">
      
  <img src="https://cdn.steminds.com/docs/images/icon.svg" alt="logo">

    </a>
    STEMinds Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Products
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Products" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Products
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../../products/eduponics_mini_extension_board/" class="md-nav__link">
        Extension board for Eduponics Mini
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Kits
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kits" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Kits
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      <label class="md-nav__link" for="__nav_3_1">
        Eduponics Mini
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Eduponics Mini" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Eduponics Mini
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../eduponics_mini_getting_started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../advance_tools/" class="md-nav__link">
        Advance manual tools
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/bme280_temperature_and_humidity/" class="md-nav__link">
        BME280 sensor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/dht11_temperature_and_humidity/" class="md-nav__link">
        DHT11 sensor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/light_sensor/" class="md-nav__link">
        BH1750 Light sensor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/water_quantity_sensor/" class="md-nav__link">
        Water level sensor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/pump/" class="md-nav__link">
        Water pump
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/rgb_led/" class="md-nav__link">
        RGB LED
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/eeprom_module/" class="md-nav__link">
        EEPROM Module
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/rtc_module/" class="md-nav__link">
        RTC Module
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/soil_moisture_sensor/" class="md-nav__link">
        Soil moisture sensor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic_sensors_usage/deep_sleep_wakeup/" class="md-nav__link">
        Deep sleep wakeup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../RGB_indicators/" class="md-nav__link">
        RGB based indicators
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../water_level_based_water_pumping/" class="md-nav__link">
        Water level based pump
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../introduction_to_mqtt/" class="md-nav__link">
        Introduction to MQTT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basic_mqtt_client/" class="md-nav__link">
        Basic MQTT client
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Eduponics MQTT APP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Eduponics MQTT APP
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#preparing-the-eduponics-mini" class="md-nav__link">
    Preparing the Eduponics Mini
  </a>
  
    <nav class="md-nav" aria-label="Preparing the Eduponics Mini">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-eduponics-mini-to-wifi" class="md-nav__link">
    Connecting Eduponics Mini to WiFi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-umqttsimple-class" class="md-nav__link">
    Adding uMQTTSimple class
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-uuid" class="md-nav__link">
    Generating UUID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-dependencies" class="md-nav__link">
    Adding dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-main-mqtt-client" class="md-nav__link">
    Adding main MQTT client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-the-eduponics-app" class="md-nav__link">
    Preparing the Eduponics APP
  </a>
  
    <nav class="md-nav" aria-label="Preparing the Eduponics APP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#downloading-installing-eduponics-app" class="md-nav__link">
    Downloading &amp; Installing Eduponics APP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connecting-eduponics-app-to-eduponics-mini" class="md-nav__link">
    Connecting Eduponics APP to Eduponics Mini
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#preparing-the-eduponics-mini" class="md-nav__link">
    Preparing the Eduponics Mini
  </a>
  
    <nav class="md-nav" aria-label="Preparing the Eduponics Mini">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-eduponics-mini-to-wifi" class="md-nav__link">
    Connecting Eduponics Mini to WiFi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-umqttsimple-class" class="md-nav__link">
    Adding uMQTTSimple class
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-uuid" class="md-nav__link">
    Generating UUID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-dependencies" class="md-nav__link">
    Adding dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-main-mqtt-client" class="md-nav__link">
    Adding main MQTT client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-the-eduponics-app" class="md-nav__link">
    Preparing the Eduponics APP
  </a>
  
    <nav class="md-nav" aria-label="Preparing the Eduponics APP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#downloading-installing-eduponics-app" class="md-nav__link">
    Downloading &amp; Installing Eduponics APP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connecting-eduponics-app-to-eduponics-mini" class="md-nav__link">
    Connecting Eduponics APP to Eduponics Mini
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="eduponics-mqtt-powered-mobile-app">Eduponics MQTT Powered Mobile APP</h1>
<p align="left">
  <img src="https://cdn.steminds.com/docs/kits/eduponics_mini/eduponics_featured.png">
</p>

<p>The Eduponics App is a special app we've developed in order to turn your kit into a complete autonomous smart watering solution.
<br/><br/>
By using the app and pairing it with the Eduponics mini kit you'll be able to control your plants remotely by pumping water when needed, view sensors data in real time such as: temperature and humidity, light intensity, water quantity and off course monitoring soil moisture levels.
<br/><br/>
The app can work anywhere, whenever you are at home, at work or on vocation. it doesn't require a local server or port forwarding.
<br/><br/>
The app currently support the following languages:
<br/><br/>
English, Hebrew, Mandarin (Chinese), Spanish, German, Ukrainian, Russian, Hindi, Portuguese
<br/><br/>
The language is selected by your system language (your mobile phone language). If you'd like us to add extra translations and would like to help us translate the app for more languages, feel free to contact us!</p>
<div class="admonition tip">
<p class="admonition-title">For now, only Android app version is available</p>
<p>Although we developed both the Android and iOS version for the Eduponics app, we haven't released the iOS app yet for the apple appstore due to app regulations and application approval process, we plan to release it as soon as possible, stay tuned!</p>
</div>
<h2 id="preparing-the-eduponics-mini">Preparing the Eduponics Mini</h2>
<p>Before we'll jump directly into our app, we need to prepare our Eduponics Mini ESP32 board first with custom software that will enable our kit to connect to the MQTT broker and publish and subscribe to and from topics.</p>
<h3 id="connecting-eduponics-mini-to-wifi">Connecting Eduponics Mini to WiFi</h3>
<p>Let's repeat the same process we've used in the basic MQTT client tutorial by creating <b>boot.py</b> file, this file will first load when our Eduponics Mini restart or the power plugged in, in this file we'll configure the WiFi credentials such as ESSID (WiFi name) and the WiFi password.
<br/><br/>
Once we've connected to the WiFi using the station.connect() command, we can print our ESP32 WiFi IP address into the console.</p>
<div class="tabbed-set" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">MicroPython</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="c1"># This code should be written into boot.py file on your Eduponics Mini board.</span>
<span class="kn">from</span> <span class="nn">umqttsimple</span> <span class="kn">import</span> <span class="n">MQTTClient</span>
<span class="kn">import</span> <span class="nn">network</span>
<span class="kn">import</span> <span class="nn">esp</span>
<span class="n">esp</span><span class="o">.</span><span class="n">osdebug</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

<span class="n">ssid</span> <span class="o">=</span> <span class="s1">&#39;WIFI_NAME&#39;</span>
<span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;WIFI_PASSWORD&#39;</span>

<span class="n">station</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>

<span class="n">station</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">station</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

<span class="k">while</span> <span class="n">station</span><span class="o">.</span><span class="n">isconnected</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
  <span class="k">pass</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connected to WiFi successfully, IP: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">station</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
</div>
</div>
<p>Now every time we restart or power the Eduponics Mini board it will automatically connect to the WiFi at our home.</p>
<div class="admonition warning">
<p class="admonition-title">2.54GhZ WiFi support only</p>
<p>Just reminding once again, the ESP32 support only 2.54GhZ WiFi networks. Most of the 5Ghz WiFi routers / access points allow both 5Ghz and 2.54Ghz, make sure to choose the 2.54Ghz one. to avoid connectivity issues make sure your network is operated on 2.54Ghz.</p>
</div>
<h3 id="adding-umqttsimple-class">Adding uMQTTSimple class</h3>
<p>As previously mentioned we'll need the umqttsimple client to communicate with the MQTT broker and use functionalities such as publishing data and subscribing to topics.
<br/><br/>
We should save this python code into file we'll call <b>umqttsimple.py</b> and we will import it using the import command every time we want to use the MQTT functionalities to communicate through the MQTT network.</p>
<div class="tabbed-set" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">MicroPython</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">usocket</span> <span class="k">as</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">machine</span>
<span class="kn">import</span> <span class="nn">ustruct</span> <span class="k">as</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">ubinascii</span> <span class="kn">import</span> <span class="n">hexlify</span>

<span class="k">class</span> <span class="nc">MQTTException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">MQTTClient</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">hexlify</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">unique_id</span><span class="p">()),</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;mqtt.eclipse.org&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepalive</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ssl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssl_params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="mi">8883</span> <span class="k">if</span> <span class="n">ssl</span> <span class="k">else</span> <span class="mi">1883</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl</span> <span class="o">=</span> <span class="n">ssl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_params</span> <span class="o">=</span> <span class="n">ssl_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pswd</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepalive</span> <span class="o">=</span> <span class="n">keepalive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_topic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_qos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_retain</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_send_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;!H&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recv_len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sh</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
            <span class="n">sh</span> <span class="o">+=</span> <span class="mi">7</span>

    <span class="k">def</span> <span class="nf">set_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">set_last_will</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">qos</span> <span class="o">&lt;=</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_topic</span> <span class="o">=</span> <span class="n">topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_qos</span> <span class="o">=</span> <span class="n">qos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lw_retain</span> <span class="o">=</span> <span class="n">retain</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean_session</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ussl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">ussl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_params</span><span class="p">)</span>
        <span class="n">premsg</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x10\0\0\0\0\0</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x04</span><span class="s2">MQTT</span><span class="se">\x04\x02\0\0</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">sz</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean_session</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sz</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pswd</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xC0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepalive</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepalive</span> <span class="o">&lt;</span> <span class="mi">65536</span>
            <span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepalive</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>
            <span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepalive</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lw_topic</span><span class="p">:</span>
            <span class="n">sz</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lw_topic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lw_msg</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x4</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lw_qos</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lw_qos</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
            <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lw_retain</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">:</span>
            <span class="n">premsg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span>
            <span class="n">sz</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">premsg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sz</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">premsg</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1">#print(hex(len(msg)), hexlify(msg, &quot;:&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lw_topic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lw_topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lw_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pswd</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="ow">and</span> <span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span>
        <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MQTTException</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xe0\0</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc0\0</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x30\0\0\0</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">qos</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">retain</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sz</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="mi">2097152</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">:</span>
            <span class="n">pkt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span>
            <span class="n">sz</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pkt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="c1">#print(hex(len(pkt)), hexlify(pkt, &quot;:&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&quot;!H&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_msg</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">:</span>
                    <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">sz</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x02</span><span class="s2">&quot;</span>
                    <span class="n">rcv_pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">rcv_pid</span> <span class="o">=</span> <span class="n">rcv_pid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">rcv_pid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">rcv_pid</span><span class="p">:</span>
                        <span class="k">return</span>
        <span class="k">elif</span> <span class="n">qos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Subscribe callback is not set&quot;</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x82\0\0\0</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&quot;!BH&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="c1">#print(hex(len(pkt)), hexlify(pkt, &quot;:&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_str</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">qos</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">))</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_msg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="c1">#print(resp)</span>
                <span class="k">assert</span> <span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MQTTException</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">return</span>

    <span class="c1"># Wait for a single incoming MQTT message and process it.</span>
    <span class="c1"># Subscribed messages are delivered to a callback previously</span>
    <span class="c1"># set by .set_callback() method. Other (internal) MQTT</span>
    <span class="c1"># messages processed internally.</span>
    <span class="k">def</span> <span class="nf">wait_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd0</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># PINGRESP</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="mh">0xf0</span> <span class="o">!=</span> <span class="mh">0x30</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">op</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_len</span><span class="p">()</span>
        <span class="n">topic_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">topic_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">topic_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">topic_len</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">topic_len</span><span class="p">)</span>
        <span class="n">sz</span> <span class="o">-=</span> <span class="n">topic_len</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">pid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sz</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pkt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x40\x02\0\0</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&quot;!H&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span>

    <span class="c1"># Checks whether a pending message from server is available.</span>
    <span class="c1"># If not, returns immediately with None. Otherwise, does</span>
    <span class="c1"># the same processing as wait_msg.</span>

    <span class="k">def</span> <span class="nf">check_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_msg</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
<h3 id="generating-uuid">Generating UUID</h3>
<p>As we've mentioned in the basic MQTT client tutorial, we could either head to <a href="https://www.uuidgenerator.net/">uuidgenerator.net</a> and copy paste the automatically generated UUID for us or generate it by ourselves.
<br/><br/>
The UUID is used to identify our device from other devices on the MQTT network.
<br/><br/>
<b>it is crucial to generate a unique UUID and not re-use it</b>.
<br/><br/>
If we want to use the second option, here is a MicroPython example code to generate unique UUID, there are few kinds: unique based on host ID and current timestamp which is what we recommend, a UUID based on MD5 hash of a namespace (if you use this method, make sure to change steminds.com to something else, something random) and the last option to generate a random UUID.</p>
<div class="tabbed-set" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">MicroPython</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uuid</span>

<span class="c1"># make a UUID based on the host ID and current time, best option.</span>
<span class="n">uuid_x</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">uuid_x</span><span class="p">)</span>

<span class="c1"># make a UUID using an MD5 hash of a namespace UUID and a name</span>
<span class="n">uuid_y</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid3</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_DNS</span><span class="p">,</span> <span class="s1">&#39;steminds.com&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">uuid_y</span><span class="p">)</span>

<span class="c1"># make a random UUID</span>
<span class="n">uuid_z</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">uuid_z</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
<h3 id="adding-dependencies">Adding dependencies</h3>
<p>In our MQTT client we'll need to use sensors such as BME280, BH1750 light sensor and more. The main code for this sensors can be long and messy, it will be frustrating to create seperate files such as bme280.py and bh1750.py so we've added all those different classes into one file we call <b>dependencies.py</b>
<br/><br/>
Make sure to save it with the same name and we will use this file to import the BME280 temperature, humidity and air pressure sensor library as well as the BH1750 light sensor library.</p>
<div class="tabbed-set" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">MicroPython</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MicroPython TinyRTC I2C Module, DS1307 RTC + AT24C32N EEPROM</span>
<span class="sd">https://github.com/mcauser/micropython-tinyrtc</span>
<span class="sd">MIT License</span>
<span class="sd">Copyright (c) 2018 Mike Causer</span>

<span class="sd">MicroPython BH1750 light sensor module</span>
<span class="sd">https://github.com/STEMinds/eduponics-mini</span>
<span class="sd">MIT License</span>
<span class="sd">Copyright (c) 2020 STEMinds</span>

<span class="sd">BME280 Library Final Document: BST-BME280-DS002-15</span>
<span class="sd">Authors: Paul Cunnane 2016, Peter Dahlebrg 2016</span>
<span class="sd">Module borrows from the Adafruit BME280 Python library. Original Copyright notices are reproduced below.</span>
<span class="sd">Those libraries were written for the Raspberry Pi.</span>
<span class="sd">Copyright (c) 2014 Adafruit Industries</span>
<span class="sd">Author: Tony DiCola</span>
<span class="sd">Based on the BMP280 driver with BME280 changes provided by</span>
<span class="sd">David J Taylor, Edinburgh (www.satsignal.eu)</span>
<span class="sd">Based on Adafruit_I2C.py created by Kevin Townsend.</span>

<span class="sd">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="sd">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="sd">in the Software without restriction, including without limitation the rights</span>
<span class="sd">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="sd">copies of the Software, and to permit persons to whom the Software is</span>
<span class="sd">furnished to do so, subject to the following conditions:</span>
<span class="sd">The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">copies or substantial portions of the Software.</span>
<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="sd">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="sd">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="sd">SOFTWARE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">machine</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">ustruct</span> <span class="kn">import</span> <span class="n">unpack</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">micropython</span> <span class="kn">import</span> <span class="n">const</span>

<span class="n">DATETIME_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 0x00-0x06</span>
<span class="n">CHIP_HALT</span>    <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="n">CONTROL_REG</span>  <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># 0x07</span>
<span class="n">RAM_REG</span>      <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># 0x08-0x3F</span>

<span class="c1"># BME280 default address.</span>
<span class="n">BME280_I2CADDR</span> <span class="o">=</span> <span class="mh">0x76</span>

<span class="c1"># Operating Modes</span>
<span class="n">BME280_OSAMPLE_1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">BME280_OSAMPLE_2</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">BME280_OSAMPLE_4</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">BME280_OSAMPLE_8</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">BME280_OSAMPLE_16</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">BME280_REGISTER_CONTROL_HUM</span> <span class="o">=</span> <span class="mh">0xF2</span>
<span class="n">BME280_REGISTER_STATUS</span> <span class="o">=</span> <span class="mh">0xF3</span>
<span class="n">BME280_REGISTER_CONTROL</span> <span class="o">=</span> <span class="mh">0xF4</span>

<span class="n">MODE_SLEEP</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">MODE_FORCED</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MODE_NORMAL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AT24C32N</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Driver for the AT24C32N 32K EEPROM.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="n">i2c_addr</span><span class="o">=</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">bpp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">i2c_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp</span> <span class="c1"># bytes per page</span>

    <span class="k">def</span> <span class="nf">capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Storage capacity in bytes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpp</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read one or more bytes from the EEPROM starting from a specific address&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">addrsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write one or more bytes to the EEPROM starting from a specific address&quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpp</span>
        <span class="n">partial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># partial page write</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">partial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpp</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">partial</span><span class="p">],</span> <span class="n">addrsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">+=</span> <span class="n">partial</span>
        <span class="c1"># full page write</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">partial</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="n">partial</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">bpp</span><span class="p">],</span> <span class="n">addrsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LightSensor</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Define some constants from the datasheet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="mh">0x5c</span> <span class="c1"># Default device I2C address</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">POWER_DOWN</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="c1"># No active state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">POWER_ON</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="c1"># Power on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RESET</span> <span class="o">=</span> <span class="mh">0x07</span> <span class="c1"># Reset data register value</span>

        <span class="c1"># Start measurement at 4lx resolution. Time typically 16ms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONTINUOUS_LOW_RES_MODE</span> <span class="o">=</span> <span class="mh">0x13</span>
        <span class="c1"># Start measurement at 1lx resolution. Time typically 120ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONTINUOUS_HIGH_RES_MODE_1</span> <span class="o">=</span> <span class="mh">0x10</span>
        <span class="c1"># Start measurement at 0.5lx resolution. Time typically 120ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONTINUOUS_HIGH_RES_MODE_2</span> <span class="o">=</span> <span class="mh">0x11</span>
        <span class="c1"># Start measurement at 1lx resolution. Time typically 120ms</span>
        <span class="c1"># Device is automatically set to Power Down after measurement.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ONE_TIME_HIGH_RES_MODE_1</span> <span class="o">=</span> <span class="mh">0x20</span>
        <span class="c1"># Start measurement at 0.5lx resolution. Time typically 120ms</span>
        <span class="c1"># Device is automatically set to Power Down after measurement.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ONE_TIME_HIGH_RES_MODE_2</span> <span class="o">=</span> <span class="mh">0x21</span>
        <span class="c1"># Start measurement at 1lx resolution. Time typically 120ms</span>
        <span class="c1"># Device is automatically set to Power Down after measurement.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ONE_TIME_LOW_RES_MODE</span> <span class="o">=</span> <span class="mh">0x23</span>
        <span class="c1"># setup I2C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">I2C</span><span class="p">(</span><span class="n">scl</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">sda</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">convertToNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="c1"># Simple function to convert 2 bytes of data</span>
        <span class="c1"># into a decimal number</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">1.2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readLight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ONE_TIME_HIGH_RES_MODE_1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertToNumber</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BME280</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">BME280_OSAMPLE_8</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="n">BME280_I2CADDR</span><span class="p">,</span><span class="n">i2c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Check that mode is valid.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BME280_OSAMPLE_1</span><span class="p">,</span> <span class="n">BME280_OSAMPLE_2</span><span class="p">,</span> <span class="n">BME280_OSAMPLE_4</span><span class="p">,</span>
                        <span class="n">BME280_OSAMPLE_8</span><span class="p">,</span> <span class="n">BME280_OSAMPLE_16</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Unexpected mode value </span><span class="si">{0}</span><span class="s1">. Set mode to one of &#39;</span>
                <span class="s1">&#39;BME280_OSAMPLE_1, BME280_OSAMPLE_2, BME280_OSAMPLE_4,&#39;</span>
                <span class="s1">&#39;BME280_OSAMPLE_8, BME280_OSAMPLE_16&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="k">if</span> <span class="n">i2c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;An I2C object is required.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sealevel</span> <span class="o">=</span> <span class="mi">101325</span>

        <span class="c1"># load calibration data</span>
        <span class="n">dig_88_a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="n">dig_e1_e7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dig_T1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P1</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">dig_P2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P5</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">dig_P6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P9</span><span class="p">,</span> \
            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H1</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;HhhHhhhhhhhhBB&quot;</span><span class="p">,</span> <span class="n">dig_88_a1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H4</span><span class="p">,</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">dig_H5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H6</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;hBbhb&quot;</span><span class="p">,</span> <span class="n">dig_e1_e7</span><span class="p">)</span>
        <span class="c1"># unfold H4, H5, keeping care of a potential sign</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H4</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_H4</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_H5</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H5</span> <span class="o">//=</span> <span class="mi">16</span>

        <span class="c1"># temporary data holders which stay allocated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l8_barray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l3_resultarray</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">MODE_SLEEP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">BME280_REGISTER_CONTROL</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_fine</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">read_raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reads the raw (uncompensated) data from the sensor.</span>
<span class="sd">            Args:</span>
<span class="sd">                result: array of length 3 or alike where the result will be</span>
<span class="sd">                stored, in temperature, pressure, humidity order</span>
<span class="sd">            Returns:</span>
<span class="sd">                None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">BME280_REGISTER_CONTROL_HUM</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">MODE_FORCED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">BME280_REGISTER_CONTROL</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_l1_barray</span><span class="p">)</span>

        <span class="c1"># Wait for conversion to complete</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">BME280_REGISTER_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># burst readout from 0xF7 to 0xFE, recommended by datasheet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem_into</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l8_barray</span><span class="p">)</span>
        <span class="n">readout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l8_barray</span>
        <span class="c1"># pressure(0xF7): ((msb &lt;&lt; 16) | (lsb &lt;&lt; 8) | xlsb) &gt;&gt; 4</span>
        <span class="n">raw_press</span> <span class="o">=</span> <span class="p">((</span><span class="n">readout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">readout</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
        <span class="c1"># temperature(0xFA): ((msb &lt;&lt; 16) | (lsb &lt;&lt; 8) | xlsb) &gt;&gt; 4</span>
        <span class="n">raw_temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">readout</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readout</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">readout</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
        <span class="c1"># humidity(0xFD): (msb &lt;&lt; 8) | lsb</span>
        <span class="n">raw_hum</span> <span class="o">=</span> <span class="p">(</span><span class="n">readout</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">readout</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>

        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_temp</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_press</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_hum</span>

    <span class="k">def</span> <span class="nf">read_compensated_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reads the data from the sensor and returns the compensated data.</span>
<span class="sd">            Args:</span>
<span class="sd">                result: array of length 3 or alike where the result will be</span>
<span class="sd">                stored, in temperature, pressure, humidity order. You may use</span>
<span class="sd">                this to read out the sensor without allocating heap memory</span>
<span class="sd">            Returns:</span>
<span class="sd">                array with temperature, pressure, humidity. Will be the one</span>
<span class="sd">                from the result parameter if not None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_raw_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l3_resultarray</span><span class="p">)</span>
        <span class="n">raw_temp</span><span class="p">,</span> <span class="n">raw_press</span><span class="p">,</span> <span class="n">raw_hum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l3_resultarray</span>
        <span class="c1"># temperature</span>
        <span class="n">var1</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_temp</span><span class="o">/</span><span class="mf">16384.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T1</span><span class="o">/</span><span class="mf">1024.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T2</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="n">raw_temp</span><span class="o">/</span><span class="mf">131072.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T1</span><span class="o">/</span><span class="mf">8192.0</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span> <span class="o">*</span> <span class="n">var2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_fine</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">var1</span> <span class="o">+</span> <span class="n">var2</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">var1</span> <span class="o">+</span> <span class="n">var2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5120.0</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="n">temp</span><span class="p">))</span>

        <span class="c1"># pressure</span>
        <span class="n">var1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_fine</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">64000.0</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="n">var1</span> <span class="o">*</span> <span class="n">var1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P6</span> <span class="o">/</span> <span class="mf">32768.0</span> <span class="o">+</span> <span class="n">var1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P5</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="p">(</span><span class="n">var2</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_P4</span> <span class="o">*</span> <span class="mf">65536.0</span><span class="p">)</span>
        <span class="n">var1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_P3</span> <span class="o">*</span> <span class="n">var1</span> <span class="o">*</span> <span class="n">var1</span> <span class="o">/</span> <span class="mf">524288.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P2</span> <span class="o">*</span> <span class="n">var1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">524288.0</span>
        <span class="n">var1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">var1</span> <span class="o">/</span> <span class="mf">32768.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var1</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="mi">30000</span>  <span class="c1"># avoid exception caused by division by zero</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1048576.0</span> <span class="o">-</span> <span class="n">raw_press</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">var2</span> <span class="o">/</span> <span class="mf">4096.0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">6250.0</span> <span class="o">/</span> <span class="n">var1</span>
            <span class="n">var1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P9</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="mf">2147483648.0</span>
            <span class="n">var2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P8</span> <span class="o">/</span> <span class="mf">32768.0</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">var1</span> <span class="o">+</span> <span class="n">var2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P7</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">110000</span><span class="p">,</span> <span class="n">pressure</span><span class="p">))</span>

        <span class="c1"># humidity</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_fine</span> <span class="o">-</span> <span class="mf">76800.0</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="n">raw_hum</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_H4</span> <span class="o">*</span> <span class="mf">64.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H5</span> <span class="o">/</span> <span class="mf">16384.0</span> <span class="o">*</span> <span class="n">h</span><span class="p">))</span> <span class="o">*</span>
             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_H2</span> <span class="o">/</span> <span class="mf">65536.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H6</span> <span class="o">/</span> <span class="mf">67108864.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span>
                                       <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H3</span> <span class="o">/</span> <span class="mf">67108864.0</span> <span class="o">*</span> <span class="n">h</span><span class="p">))))</span>
        <span class="n">humidity</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H1</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">524288.0</span><span class="p">)</span>
        <span class="c1"># humidity = max(0, min(100, humidity))</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">humidity</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">humidity</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sealevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sealevel</span>

    <span class="nd">@sealevel</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sealevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">30000</span> <span class="o">&lt;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">120000</span><span class="p">:</span>  <span class="c1"># just ensure some reasonable value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sealevel</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Altitude in m.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="nb">pow</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">44330</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_compensated_data</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">__sealevel</span><span class="p">,</span> <span class="mf">0.1903</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dew_point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the dew point temperature for the current Temperature</span>
<span class="sd">        and Humidity measured pair</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_compensated_data</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.4343</span> <span class="o">+</span> <span class="p">(</span><span class="mf">17.62</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">243.12</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">243.12</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="mf">17.62</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; human readable values &quot;&quot;&quot;</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_compensated_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">hPa&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span>
                <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">DS1307</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Driver for the DS1307 RTC.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x68</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekday_start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_dec2bcd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert decimal to binary coded decimal (BCD) format&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bcd2dec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert binary coded decimal (BCD) format to decimal&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get or set datetime&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">datetime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">DATETIME_REG</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">,</span> <span class="c1"># year</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="c1"># month</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="c1"># day</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weekday_start</span><span class="p">),</span> <span class="c1"># weekday</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="c1"># hour</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="c1"># minute</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bcd2dec</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">),</span> <span class="c1"># second</span>
                <span class="mi">0</span> <span class="c1"># subseconds</span>
            <span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7F</span> <span class="c1"># second, msb = CH, 1=halt, 0=go</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="c1"># minute</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># hour</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weekday_start</span><span class="p">)</span> <span class="c1"># weekday</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># day</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># month</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec2bcd</span><span class="p">(</span><span class="n">datetime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2000</span><span class="p">)</span> <span class="c1"># year</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_halt</span><span class="p">):</span>
            <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">DATETIME_REG</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">halt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Power up, power down or check status&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halt</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">DATETIME_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">|=</span> <span class="n">CHIP_HALT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHIP_HALT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">DATETIME_REG</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="n">reg</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">square_wave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output square wave on pin SQ at 1Hz, 4.096kHz, 8.192kHz or 32.768kHz,</span>
<span class="sd">        or disable the oscillator and output logic level high/low.&quot;&quot;&quot;</span>
        <span class="n">rs0</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sqw</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">sqw</span> <span class="o">==</span> <span class="mi">32</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">rs1</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sqw</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">sqw</span> <span class="o">==</span> <span class="mi">32</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">out</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">sqw</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sqw</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">rs0</span> <span class="o">|</span> <span class="n">rs1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">sqw</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">CONTROL_REG</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="n">reg</span><span class="p">]))</span>
</code></pre></div>
</div>
</div>
<h3 id="adding-main-mqtt-client">Adding main MQTT client</h3>
<p>The main MQTT client we will use now is very different from the previous basic MQTT example we've done.
<br/><br/>
In this example, we will integrate all our sensors and use them when needed, we will start by defining in our ode all the sensors such as ADC for the soil moisture sensor, light sensor, BME280 sensor and water quantity sensor.
<br/><br/>
Then we'll have multiple topics, the topics we will use are:</p>
<ul>
<li>plants/soil</li>
<li>plants/environment</li>
<li>plants/water</li>
</ul>
<p>The plants/soil topic is used to publish soil moisture sensor data, take a look at the JSON file below:</p>
<div class="highlight"><pre><span></span><code>  plant = {
      &quot;id&quot;:0,
      &quot;name&quot;:&quot;Plant A&quot;,
      &quot;enabled&quot;:1,
      &quot;moisture&quot;:normal_reading
  }
</code></pre></div>
<p>We can name the plant as we wish and it will show on our app, enabled can be changed between 1 or 0 which will describe if the plant can be used or not (watering functionality mainly) and inside moisture we add the soil moisture sensor values.
<br/><br/>
It's import to keep the ID 0 as we use only one soil moisture, if you use the IO extension pins to add more plants, you can change the ID from 0 to 1,2,3 .. as follows:</p>
<div class="highlight"><pre><span></span><code>  plants = [{
      &quot;id&quot;:0,
      &quot;name&quot;:&quot;Plant A&quot;,
      &quot;enabled&quot;:1,
      &quot;moisture&quot;:normal_reading
    },{
      &quot;id&quot;:1,
      &quot;name&quot;:&quot;Plant B&quot;,
      &quot;enabled&quot;:1,
      &quot;moisture&quot;:normal_reading_two
    }]
</code></pre></div>
<p>In the plants/environment topic we will publish temperature, humidity, sunlight and water quantity using the rest of the sensors that are integrated in the Eduponics Mini kit.
<br/><br/>
And finally plants/water will be used to subscribe instead of publishing, in our app we can press the watering icon which will water our plants, our ESP32 will receive the message from the plants/water topic and water the plants accordingly.
<br/><br/>
Note in water_plant() function the following lines:</p>
<div class="highlight"><pre><span></span><code>  # check if soil moisture is bigger than 60
  if(int(json.loads(get_soil_moisture())[&quot;moisture&quot;].replace(&quot;%&quot;,&quot;&quot;)) &gt; 60):
      # enough water, stop giving water
      break;
</code></pre></div>
<p>We've set default of allowing to give water only if the plant has less than 60% soil moisture or if the water quantity sensor says there is no more water left. this configuration can be played with as well as to add automatic watering and not manual operation through the app.
<br/><br/>
Here is the complete code, make sure to save it as <b>main.py</b> as this will be our main program:</p>
<div class="tabbed-set" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">MicroPython</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MicroPython MQTT Eduponics APP Client</span>
<span class="sd">https://github.com/STEMinds/eduponics-mini</span>
<span class="sd">MIT License</span>
<span class="sd">Copyright (c) 2020 STEMinds</span>
<span class="sd">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="sd">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="sd">in the Software without restriction, including without limitation the rights</span>
<span class="sd">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="sd">copies of the Software, and to permit persons to whom the Software is</span>
<span class="sd">furnished to do so, subject to the following conditions:</span>
<span class="sd">The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">copies or substantial portions of the Software.</span>
<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="sd">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="sd">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="sd">SOFTWARE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">umqttsimple</span> <span class="kn">import</span> <span class="n">MQTTClient</span>
<span class="kn">from</span> <span class="nn">dependencies</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">machine</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># set adc (analog to digital) on pin 35</span>
<span class="n">adc</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">ADC</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">35</span><span class="p">))</span>
<span class="c1"># set 11dB input attenuation (voltage range roughly 0.0v - 3.6v)</span>
<span class="n">adc</span><span class="o">.</span><span class="n">atten</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">ADC</span><span class="o">.</span><span class="n">ATTN_11DB</span><span class="p">)</span>

<span class="c1"># Configure light sensor</span>
<span class="n">light_sensor</span> <span class="o">=</span> <span class="n">LightSensor</span><span class="p">()</span>

<span class="c1"># Configure BME280</span>
<span class="c1"># setup I2C connection</span>
<span class="n">i2c</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">I2C</span><span class="p">(</span><span class="n">scl</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">sda</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="c1"># Initialize BME280 object with default address 0x76</span>
<span class="n">bme_sensor</span> <span class="o">=</span> <span class="n">BME280</span><span class="p">(</span><span class="n">i2c</span><span class="o">=</span><span class="n">i2c</span><span class="p">)</span>
<span class="c1"># initialize dht object, DHT11 coonected to IO19</span>
<span class="c1">#d = dht.DHT11(machine.Pin(19))</span>

<span class="c1"># define water level sensor as INPUT on IO pin number 21</span>
<span class="n">water_level</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>

<span class="c1"># define pump on pin IO23 as OUTPUT</span>
<span class="n">pump</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>

<span class="c1"># MQTT Unique ID</span>
<span class="n">UUID</span> <span class="o">=</span> <span class="s2">&quot;YOUR_UUID_GENERATED_ID&quot;</span>
<span class="c1"># MQTT Topics</span>
<span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plants/soil&quot;</span><span class="p">,</span><span class="s2">&quot;plants/environment&quot;</span><span class="p">,</span><span class="s2">&quot;plants/water&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_soil_moisture</span><span class="p">():</span>

    <span class="c1"># sensor min and max values</span>
    <span class="c1"># can be changed and callibrated</span>
    <span class="n">minVal</span> <span class="o">=</span> <span class="mi">710</span>
    <span class="n">maxVal</span> <span class="o">=</span> <span class="mi">4095</span>

    <span class="c1"># read soil moisture sensor data</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">adc</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># scale the value based on maxVal and minVal</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">minVal</span> <span class="o">-</span> <span class="n">maxVal</span><span class="p">)</span>
    <span class="c1"># get calculated scale</span>
    <span class="n">normal_reading</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">val</span> <span class="o">-</span> <span class="n">maxVal</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span><span class="s2">&quot;%&quot;</span><span class="p">))</span>
    <span class="c1"># we can also get inverted value if needed</span>
    <span class="n">inverted_reading</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">minVal</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span><span class="s2">&quot;%&quot;</span><span class="p">))</span>
    <span class="c1"># for this example we&#39;ll return only the normal reading</span>
    <span class="c1"># put everything in a JSON format suitable for the eduponics app</span>
    <span class="n">plant</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Plant A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enabled&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;moisture&quot;</span><span class="p">:</span><span class="n">normal_reading</span>
    <span class="p">}</span>
    <span class="c1"># return the data</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">plant</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_environmental_data</span><span class="p">():</span>

    <span class="c1"># get light from the light sensor</span>
    <span class="n">lux</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">light_sensor</span><span class="o">.</span><span class="n">readLight</span><span class="p">())</span>
    <span class="c1"># get bme280 sensor data</span>
    <span class="n">bme280_values</span> <span class="o">=</span> <span class="n">bme_sensor</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">bme280_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">bme280_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">humidity</span> <span class="o">=</span> <span class="n">bme280_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># get DHT11 sensor data</span>
    <span class="c1"># measure sensor data</span>
    <span class="c1">#d.measure()</span>
    <span class="c1"># get temperature and humidity</span>
    <span class="c1">#temperature = d.temperature()</span>
    <span class="c1">#humidity = d.humidity()</span>
    <span class="c1"># get water quantity</span>
    <span class="n">water_quantity</span> <span class="o">=</span> <span class="n">water_level</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

    <span class="c1"># put all this data into a JSON object</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;temp&quot;</span><span class="p">:</span><span class="n">temperature</span><span class="p">,</span>
        <span class="s2">&quot;humidity&quot;</span><span class="p">:</span><span class="n">humidity</span><span class="p">,</span>
        <span class="s2">&quot;sunlight&quot;</span><span class="p">:</span><span class="n">lux</span><span class="p">,</span>
        <span class="s2">&quot;water_quantity&quot;</span><span class="p">:</span><span class="n">water_quantity</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">water_plant</span><span class="p">():</span>

    <span class="c1"># turn on the pump</span>
    <span class="n">pump</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># get water quantity</span>
    <span class="n">water_quantity</span> <span class="o">=</span> <span class="n">water_level</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="c1"># if water level is not empty, keep doing it</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">water_quantity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># not empty and plant water is not full yet, keep giving water</span>
        <span class="c1"># check if soil moisture is bigger than 60</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_soil_moisture</span><span class="p">())[</span><span class="s2">&quot;moisture&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">):</span>
            <span class="c1"># enough water, stop giving water</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1"># wait for half a second and check again</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># get water quantity updated value</span>
        <span class="n">water_quantity</span> <span class="o">=</span> <span class="n">water_level</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

    <span class="c1"># turn the pump off, either plant has enough water or no water at all.</span>
    <span class="n">pump</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">on_message_callback</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    this is a callback, will be called when the app asks for certain information</span>
<span class="sd">    such as to water the plants when the watering button pressed</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># convert topic and message byte to string</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="k">if</span><span class="p">(</span><span class="n">topic</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plants/soil&quot;</span> <span class="o">%</span> <span class="n">UUID</span> <span class="ow">or</span> <span class="n">topic</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plants/environment&quot;</span> <span class="o">%</span> <span class="n">UUID</span><span class="p">):</span>
        <span class="c1"># Do nothing, we only publish to those topics</span>
        <span class="k">pass</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">topic</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plants/water&quot;</span> <span class="o">%</span> <span class="n">UUID</span><span class="p">):</span>
        <span class="c1"># when the app request for plant watering it goes here</span>
        <span class="k">if</span><span class="p">(</span><span class="s2">&quot;key&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;status&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">):</span>
            <span class="c1"># valid request, let&#39;s process it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span><span class="p">):</span>
                <span class="c1"># it&#39;s waiting for us to water it, let&#39;s water it</span>
                <span class="n">water_plant</span><span class="p">()</span>
                <span class="c1"># after watering, publish success message of watering</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span><span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;ok&quot;</span><span class="p">}</span>
                <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plants/water&quot;</span> <span class="o">%</span> <span class="n">UUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">connect_and_subscribe</span><span class="p">():</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[-] Connecting to MQTT client ...&quot;</span><span class="p">)</span>
    <span class="c1"># set the MQTT broker object</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">()</span>
    <span class="c1"># set a callback for incoming messages (subscribed topics)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">on_message_callback</span><span class="p">)</span>
    <span class="c1"># connect to the broker</span>
    <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># subscribe to the topics</span>
    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">UUID</span><span class="p">,</span><span class="n">topic</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[-] Subscribed to </span><span class="si">%s</span><span class="s2"> successfully&quot;</span> <span class="o">%</span> <span class="n">topic</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[-] Connected to </span><span class="si">%s</span><span class="s2"> MQTT broker successfully&quot;</span> <span class="o">%</span> <span class="n">client</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client</span>

<span class="k">def</span> <span class="nf">restart_and_reconnect</span><span class="p">():</span>
    <span class="c1"># something  went wrong, reconnect in 5 seconds ...</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Failed to connect to MQTT broker. Reconnecting...&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">connect_and_subscribe</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">restart_and_reconnect</span><span class="p">()</span>

<span class="c1"># configure few variables</span>
<span class="n">last_message</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">message_interval</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">previous_soil_moisture</span> <span class="o">=</span> <span class="s2">&quot;0%&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># check if there are new messages pending to be processed</span>
        <span class="c1"># if there are, redirect them to callback on_message_callback()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">check_msg</span><span class="p">()</span>

        <span class="c1"># check if the last published data wasn&#39;t less than message_interval</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">message_interval</span><span class="p">:</span>
            <span class="c1"># get soil moisture</span>
            <span class="n">current_soil_moisture</span> <span class="o">=</span> <span class="n">get_soil_moisture</span><span class="p">()</span>
            <span class="c1"># check if previous data and new data is the same</span>
            <span class="k">if</span><span class="p">(</span><span class="n">previous_soil_moisture</span> <span class="o">!=</span> <span class="n">current_soil_moisture</span><span class="p">):</span>
                <span class="c1"># it&#39;s not the same, publish the new data</span>
                <span class="n">previous_soil_moisture</span> <span class="o">=</span> <span class="n">current_soil_moisture</span>
                <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plants/soil&quot;</span> <span class="o">%</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">current_soil_moisture</span><span class="p">)</span>
                <span class="c1">#print(&quot;[-] published soil moisture&quot;)</span>

            <span class="c1"># update environmetal data</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">get_environmental_data</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/plants/environment&quot;</span> <span class="o">%</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
            <span class="c1">#print(&quot;[-] published evironmental data&quot;)</span>

            <span class="c1"># update last message timestamp</span>
            <span class="n">last_message</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># if something goes wrong, reconnct to MQTT server</span>
        <span class="n">restart_and_reconnect</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
<h2 id="preparing-the-eduponics-app">Preparing the Eduponics APP</h2>
<p>Now once we have everything ready on our ESP32 Eduponics Mini hardware, it's time to move to the app installation and preparation.</p>
<h3 id="downloading-installing-eduponics-app">Downloading &amp; Installing Eduponics APP</h3>
<p>Currently the app is only available on the Android store and should be able to work on most if not all Android phones. To download, search "Eduponics" in playstore app and you should find it right away.</p>
<p align="center">
  <img src="https://cdn.steminds.com/docs/kits/eduponics_mini/eduponics_mini_android_store.png">
</p>

<p>Alternatively you can install it directly to your phone using the web browser playstore application: <a href="https://play.google.com/store/apps/details?id=com.steminds.eduponics">Eduponics Playstore APP</a></p>
<h3 id="connecting-eduponics-app-to-eduponics-mini">Connecting Eduponics APP to Eduponics Mini</h3>
<p>After downloading and launching the app successfully a popup window will show that the hardware is not initialized, this is normal and will happen on first launch of the app or if we've pressed the "wipe data" button in settings to wipe the internal memory of the app.
<br/><br/>
In this window press "Let's go!" and it will take you automatically to the settings page to bind the Eduponics Mini hardware with the APP.</p>
<p align="center">
  <img style="max-width:50%; height:auto;" src="https://cdn.steminds.com/docs/kits/eduponics_mini/eduponics_app_setup_step_1.jpeg">
</p>

<p>Once we've  been redirected successfully, it's time to bind the app with our hardware.
In order to do so - we'll need the UUID we've generated earlier and initialized in our eduponics mini hardware, we can either type it manually or take a picture of a QR code with the UUID inside of it.</p>
<div class="admonition warning">
<p class="admonition-title">Make sure to press the 'Enter' key on the virtual keyboard</p>
<p>After you've typed the UUID completely, press the enter key on the virtual keyboard to confirm the UUID, this should complete the process.</p>
</div>
<p align="center">
  <img style="max-width:50%; height:auto;" src="https://cdn.steminds.com/docs/kits/eduponics_mini/eduponics_app_setup_step_2.jpeg">
</p>

<p>Once the virtual key entered successfully, we are now successfully connected to the same channel (the topics) as our Eduponics Mini hardware! it's time to go back to the "Control" tab and see if we can get real time data from our device.</p>
<p align="center">
  <img style="max-width:50%; height:auto;" src="https://cdn.steminds.com/docs/kits/eduponics_mini/eduponics_app_setup_step_3.jpeg">
</p>

<p>Now you can monitor your plant from everywhere, water it remotely and track the sensors data to make smarter decisions.
As the app doesn't use any external server except the MQTT broker, you can control it even outside of your home network.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->


<footer class="md-footer">
  
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
        <script src="../../../../javascripts/extra.js"></script>
      
    
  </body>
</html>